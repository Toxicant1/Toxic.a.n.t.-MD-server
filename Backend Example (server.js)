const express = require('express');
const cors = require('cors');
const { default: makeWASocket, useMultiFileAuthState } = require('@whiskeysockets/baileys');
const fs = require('fs');
const path = require('path');

const app = express();
app.use(cors());
app.use(express.json());
app.use(express.static('public'));

app.post('/api/get-code', async (req, res) => {
  const { phone } = req.body;
  if(!phone) return res.status(400).json({ error: 'Phone number required' });

  const { state, saveCreds } = await useMultiFileAuthState(path.join('sessions', phone));
  const sock = makeWASocket({
    auth: state,
    printQRInTerminal: false
  });

  try {
    const code = await sock.requestPairingCode(phone);
    console.log(`Generated code for ${phone}: ${code}`);
    res.json({ code });
  } catch(err) {
    console.error(err);
    res.status(500).json({ error: 'Failed to generate code' });
  }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`Pairing server running on port ${PORT}`));